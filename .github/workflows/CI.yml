# CI Pipeline with stages: Lint/Test â†’ Version Bump â†’ Build â†’ Release
name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  # Stage 1: Lint and Test (runs in parallel)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
      - name: Set up Python
        run: uv python install 3.11
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-
            ${{ runner.os }}-cargo-
      - name: Install dependencies
        run: |
          uv venv --python 3.11
          uv pip install nox
      - name: Run Python linting
        run: |
          source .venv/bin/activate
          nox -f dev/noxfile.py -s lint
      - name: Run Rust linting
        run: |
          source .venv/bin/activate
          nox -f dev/noxfile.py -s rust_lint

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ matrix.python-version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-${{ matrix.python-version }}-
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-
      - name: Install dependencies
        run: |
          uv venv --python ${{ matrix.python-version }}
          uv pip install maturin nox
      - name: Run tests with nox (skip slow tests)
        timeout-minutes: 10
        run: |
          source .venv/bin/activate
          nox -f dev/noxfile.py -s tests_quick-${{ matrix.python-version }} -- -v

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
      - name: Set up Python
        run: uv python install 3.11
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-
            ${{ runner.os }}-cargo-
      - name: Install dependencies
        run: |
          uv venv --python 3.11
          uv pip install nox
      - name: Run Python wrapper coverage
        run: |
          source .venv/bin/activate
          nox -f dev/noxfile.py -s coverage
      - name: Run post_processors coverage
        run: |
          source .venv/bin/activate
          nox -f dev/noxfile.py -s coverage_post_processors
      - name: Try Rust coverage (may fail on older toolchain)
        continue-on-error: true
        run: |
          source .venv/bin/activate
          cargo install cargo-llvm-cov || echo "Skipping Rust coverage due to toolchain version"
          nox -f dev/noxfile.py -s coverage_rust_llvm || echo "Rust coverage not available on this toolchain"
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 90
          MINIMUM_ORANGE: 80
      - name: Store Pull Request comment to be posted
        uses: actions/upload-artifact@v4
        if: steps.coverage_comment.outputs.COMMENT_FILE_WRITTEN == 'true'
        with:
          name: python-coverage-comment
          path: python-coverage-comment.txt
      - name: Archive coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            htmlcov/
            htmlcov_post_processors/
            coverage/
      - name: Generate coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Wrapper Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f htmlcov/index.html ]; then
            COVERAGE=$(grep -oP 'pc_cov">\K[0-9]+' htmlcov/index.html | head -1)
            echo "âœ… **$COVERAGE%** - Python wrapper (python/rs_document/)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reference Implementation Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f htmlcov_post_processors/index.html ]; then
            COVERAGE=$(grep -oP 'pc_cov">\K[0-9]+' htmlcov_post_processors/index.html | head -1)
            echo "âœ… **$COVERAGE%** - post_processors.py reference" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rust Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/rust-llvm/index.html ]; then
            echo "âœ… Rust coverage generated (requires Rust 1.82+)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Rust coverage not available (requires Rust 1.82+)" >> $GITHUB_STEP_SUMMARY
            echo "   _Note: Rust code is thoroughly tested via 102 Python tests_" >> $GITHUB_STEP_SUMMARY
          fi

  # Stage 2: Version Bump (only on main branch pushes, after lint/test/coverage pass)
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    needs: [lint, test, coverage]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && !startsWith(github.event.head_commit.message, 'bump:')
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag: ${{ steps.get_version.outputs.tag }}
      bump_happened: ${{ steps.bump.outputs.bump_happened }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: |
          uv venv --python 3.11
          uv pip install commitizen

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if bump is needed
        id: check_bump
        run: |
          source .venv/bin/activate
          if cz bump --dry-run --yes 2>&1 | grep -q "bump:"; then
            echo "needs_bump=true" >> $GITHUB_OUTPUT
          else
            echo "needs_bump=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Bump version
        id: bump
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          source .venv/bin/activate
          cz bump --yes --changelog
          echo "bump_happened=true" >> $GITHUB_OUTPUT

      - name: Get new version
        id: get_version
        run: |
          source .venv/bin/activate
          NEW_VERSION=$(cz version --project)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Verify and push changes
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          # List tags to verify the tag was created
          echo "Tags after bump:"
          git tag -l "v*" | tail -5

          # Push commit and tags
          git push origin ${{ github.ref_name }}
          git push origin --tags

  # Stage 3: Build (only after lint/test pass and version bump completes)
  linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: [lint, test, bump-version]
    if: needs.lint.result == 'success' && needs.test.result == 'success' && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    strategy:
      matrix:
        target: [x86_64, x86, aarch64, armv7, s390x, ppc64le]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag || github.ref }}
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest
    needs: [lint, test, bump-version]
    if: needs.lint.result == 'success' && needs.test.result == 'success' && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    strategy:
      matrix:
        target: [x64, x86]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag || github.ref }}
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: ${{ matrix.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest
    needs: [lint, test, bump-version]
    if: needs.lint.result == 'success' && needs.test.result == 'success' && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    strategy:
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag || github.ref }}
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest
    needs: [lint, test, bump-version]
    if: needs.lint.result == 'success' && needs.test.result == 'success' && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag || github.ref }}
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # Stage 4: Release to PyPI (only when version was bumped and tag exists)
  release:
    name: Release to PyPI
    runs-on: ubuntu-latest
    needs: [bump-version, linux, windows, macos, sdist]
    if: needs.bump-version.outputs.bump_happened == 'true' && needs.bump-version.outputs.tag != ''
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

  # Create GitHub Release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [bump-version, release]
    if: needs.bump-version.outputs.bump_happened == 'true' && needs.bump-version.outputs.tag != ''
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag }}

      - name: Extract current version changelog
        id: changelog
        run: |
          # Extract only the current version's changelog entry
          VERSION="${{ needs.bump-version.outputs.version }}"

          # Use awk to extract from current version header to the next version header (or end of file)
          awk "/^## v${VERSION}/ {flag=1; next} /^## v[0-9]/ {flag=0} flag" CHANGELOG.md > release_notes_raw.md

          # If extraction is empty, try including the header
          if [ ! -s release_notes_raw.md ]; then
            awk "/^## v${VERSION}/,/^## v[0-9]/ {print} /^## v[0-9]/ && !/^## v${VERSION}/ {exit}" CHANGELOG.md > release_notes_raw.md
          fi

          # Clean up the changelog:
          # - Remove lines that are just "- -" (double bullets)
          # - Remove lines with just dashes and whitespace
          # - Remove emoji lines and co-authored lines (already in commit)
          # - Keep only meaningful content
          sed -E \
            -e '/^- -/d' \
            -e '/^-\s*$/d' \
            -e '/ðŸ¤– Generated with/d' \
            -e '/Co-Authored-By:/d' \
            -e '/Signed-off-by:/d' \
            release_notes_raw.md > release_notes.md

          # If still empty, use a default message
          if [ ! -s release_notes.md ]; then
            echo "## Release ${{ needs.bump-version.outputs.tag }}" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> release_notes.md
          fi

          echo "Release notes:"
          cat release_notes.md

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Create GitHub Release with artifacts
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.bump-version.outputs.tag }}
          name: Release ${{ needs.bump-version.outputs.tag }}
          bodyFile: release_notes.md
          artifacts: "dist/*"
          artifactContentType: application/octet-stream
          draft: false
          prerelease: false
